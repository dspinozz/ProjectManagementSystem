@page "/admin"
@using ProjectManagementSystem.UI.Services
@using ProjectManagementSystem.UI.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject IAuditService AuditService

<PageTitle>Admin Panel - Project Management System</PageTitle>

<div class="admin-container">
    <h1>Admin Panel</h1>
    <p class="subtitle">Audit Log Viewer</p>

    <div class="section">
        <div class="section-header">
            <h2>Audit Logs</h2>
            <button class="btn btn-primary" @onclick="LoadAuditLogs">Refresh</button>
        </div>

        @if (isLoading)
        {
            <div class="loading">Loading audit logs...</div>
        }
        else if (auditLogs.Any())
        {
            <div class="audit-table">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Entity Type</th>
                            <th>Entity ID</th>
                            <th>User</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in auditLogs)
                        {
                            <tr>
                                <td>@log.Timestamp.ToString("MMM dd, yyyy HH:mm:ss")</td>
                                <td><span class="action-badge action-@log.Action.ToLower()">@log.Action</span></td>
                                <td>@log.EntityType</td>
                                <td class="entity-id">@log.EntityId</td>
                                <td>@(log.UserName ?? log.UserId)</td>
                                <td>@(log.IpAddress ?? "N/A")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (totalPages > 1)
            {
                <div class="pagination">
                    <button class="btn" @onclick="PreviousPage" disabled="@(currentPage == 1)">Previous</button>
                    <span>Page @currentPage of @totalPages</span>
                    <button class="btn" @onclick="NextPage" disabled="@(currentPage == totalPages)">Next</button>
                </div>
            }
        }
        else
        {
            <div class="empty-state">No audit logs found.</div>
        }
    </div>
</div>

@code {
    private List<AuditLogDto> auditLogs = new();
    private bool isLoading = true;
    private int currentPage = 1;
    private const int pageSize = 50;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadAuditLogs();
    }

    private async Task LoadAuditLogs()
    {
        isLoading = true;
        try
        {
            auditLogs = await AuditService.GetAuditLogsAsync(currentPage, pageSize);
            // In a real implementation, you'd get total count from API
            totalPages = (int)Math.Ceiling(auditLogs.Count / (double)pageSize);
        }
        catch { }
        finally
        {
            isLoading = false;
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadAuditLogs();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadAuditLogs();
        }
    }
}

<style>
    .admin-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .subtitle {
        color: #666;
        margin-bottom: 2rem;
    }

    .section {
        margin-top: 2rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .audit-table {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #f5f5f5;
    }

    th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e0e0e0;
    }

    td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .entity-id {
        font-family: monospace;
        font-size: 0.85rem;
        color: #666;
    }

    .action-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .action-create { background: #e8f5e9; color: #388e3c; }
    .action-update { background: #fff3e0; color: #f57c00; }
    .action-delete { background: #ffebee; color: #d32f2f; }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 2rem;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .btn-primary {
        background-color: #667eea;
        color: white;
    }
</style>
